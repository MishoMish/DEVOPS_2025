#!/bin/bash
# ===========================================
# Pre-Commit Hook - Lint all staged file types
# ===========================================

# Load NVM if available
[ -s "$HOME/.nvm/nvm.sh" ] && \. "$HOME/.nvm/nvm.sh"

echo "üîç Running pre-commit checks..."
echo ""

FAILED=0

# Get all staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No files staged."
  exit 0
fi

# ===========================================
# Check JavaScript files (ESLint)
# ===========================================
JS_FILES=$(echo "$STAGED_FILES" | grep '^api-service/.*\.js$' | sed 's|^api-service/||' || true)

if [ -n "$JS_FILES" ]; then
  echo "üìù Linting JavaScript files..."
  cd api-service
  
  if [ ! -d "node_modules" ]; then
    npm ci --silent
  fi
  
  npx eslint $JS_FILES
  if [ $? -ne 0 ]; then
    FAILED=1
  fi
  cd ..
fi

# ===========================================
# Check HTML files (HTMLHint)
# ===========================================
HTML_FILES=$(echo "$STAGED_FILES" | grep '^web-service/.*\.html$' || true)

if [ -n "$HTML_FILES" ]; then
  echo "üìù Checking HTML files..."
  cd web-service
  
  for file in $(echo "$HTML_FILES" | sed 's|^web-service/||'); do
    if command -v npx >/dev/null 2>&1; then
      npx htmlhint "$file" 2>/dev/null || FAILED=1
    fi
  done
  cd ..
fi

# ===========================================
# Check Shell scripts (shellcheck)
# ===========================================
SHELL_FILES=$(echo "$STAGED_FILES" | grep '^scripts/.*\.sh$' || true)

if [ -n "$SHELL_FILES" ]; then
  echo "üìù Checking shell scripts..."
  
  for file in $SHELL_FILES; do
    if command -v shellcheck >/dev/null 2>&1; then
      shellcheck "$file" || FAILED=1
    fi
  done
fi

# ===========================================
# Check YAML files (basic syntax)
# ===========================================
YAML_FILES=$(echo "$STAGED_FILES" | grep '\.yaml$' || true)

if [ -n "$YAML_FILES" ]; then
  echo "üìù Validating YAML files..."
  
  for file in $YAML_FILES; do
    if command -v python3 >/dev/null 2>&1; then
      python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null || FAILED=1
    fi
  done
fi

# ===========================================
# Check SQL files (basic validation)
# ===========================================
SQL_FILES=$(echo "$STAGED_FILES" | grep '\.sql$' || true)

if [ -n "$SQL_FILES" ]; then
  echo "üìù Validating SQL files..."
  
  for file in $SQL_FILES; do
    if [ -s "$file" ]; then
      # Check for dangerous operations
      if grep -qi "DROP DATABASE\|TRUNCATE" "$file"; then
        echo "  ‚ö†Ô∏è  $file contains dangerous SQL operations"
        FAILED=1
      fi
    fi
  done
fi

# ===========================================
# Result
# ===========================================
if [ $FAILED -ne 0 ]; then
  echo ""
  echo "‚ùå Pre-commit checks failed! Fix the errors above."
  exit 1
fi

echo "‚úÖ All checks passed!"
