#!/bin/sh
# ===========================================
# Pre-Push Hook - Full validation before push
# ===========================================

echo "ğŸš€ Running pre-push checks..."
echo ""

# ===========================================
# Step 0/4: Validate Branch Naming Convention
# ===========================================
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸŒ¿ Step 0/4: Validating branch name: '$BRANCH_NAME'"

# Allow main branches without restrictions
if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "develop" ]; then
  echo "âœ… Protected branch '$BRANCH_NAME' - naming check skipped"
else
  VALID_PATTERN="^(feature|feat|fix|bugfix|hotfix|chore|docs|refactor|test|style|perf|ci)/[0-9]+-[a-z0-9-]+$"
  
  if echo "$BRANCH_NAME" | grep -Eq "$VALID_PATTERN"; then
    echo "âœ… Branch name follows convention!"
  else
    echo ""
    echo "âŒ Invalid branch name: '$BRANCH_NAME'"
    echo ""
    echo "Branch names must follow: <type>/<task-number>-<description>"
    echo "Examples: feature/123-add-login, fix/456-memory-leak"
    echo ""
    exit 1
  fi
fi
echo ""

# Navigate to api-service directory
cd api-service

# Ensure dependencies are installed
if [ ! -d "node_modules" ]; then
  echo "ğŸ“¦ Installing dependencies..."
  npm ci --silent
fi

# ===========================================
# Step 1/4: Run full linting
# ===========================================
echo "ğŸ“ Step 1/4: Running full lint check..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed!"
  exit 1
fi
echo "âœ… Linting passed!"
echo ""

# ===========================================
# Step 2/4: Run unit tests
# ===========================================
echo "ğŸ§ª Step 2/4: Running unit tests..."
npm test -- --passWithNoTests --coverage=false
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed!"
  exit 1
fi
echo "âœ… Unit tests passed!"
echo ""

# ===========================================
# Step 3/4: Check for security vulnerabilities
# ===========================================
echo "ğŸ”’ Step 3/4: Checking for security vulnerabilities..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo "âš ï¸  Security vulnerabilities found!"
  echo "ğŸ’¡ Run 'npm audit fix' to fix them."
  exit 1
fi
echo "âœ… No high severity vulnerabilities!"
echo ""

# ===========================================
# Step 4/4: Done
# ===========================================
echo "============================================"
echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Pushing to remote..."
echo "============================================"
