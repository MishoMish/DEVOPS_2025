#!/bin/bash
# Pre-push hook - run full validation

# Load NVM if available
[ -s "$HOME/.nvm/nvm.sh" ] && \. "$HOME/.nvm/nvm.sh"

echo "Running pre-push checks..."
echo ""

FAILED=0
ERRORS=""

# Validate branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
echo "[BRANCH] Checking: $BRANCH_NAME"

if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "develop" ]; then
  echo "  OK - protected branch"
else
  VALID_PATTERN="^(feature|feat|fix|bugfix|hotfix|chore|docs|refactor|test|style|perf|ci)/[0-9]+-[a-z0-9-]+$"
  
  if echo "$BRANCH_NAME" | grep -Eq "$VALID_PATTERN"; then
    echo "  OK - valid naming"
  else
    FAILED=1
    ERRORS="$ERRORS\n[BRANCH NAME INVALID]\nGot: '$BRANCH_NAME'\nExpected: <type>/<task-number>-<description>\nExamples: feature/123-add-login, fix/456-memory-leak\n"
    echo "  FAILED - invalid branch name"
  fi
fi
echo ""

# Navigate to api-service directory
cd api-service

# Ensure dependencies are installed
if [ ! -d "node_modules" ]; then
  echo "[NPM] Installing dependencies..."
  npm ci --silent
fi

# Step 1: Lint
echo "[LINT] Running ESLint..."
LINT_OUTPUT=$(npm run lint 2>&1)
if [ $? -ne 0 ]; then
  FAILED=1
  ERRORS="$ERRORS\n[ESLINT FAILED]\n$LINT_OUTPUT\n"
  echo "  FAILED - see errors below"
else
  echo "  OK"
fi
echo ""

# Step 2: Tests
echo "[TEST] Running unit tests..."
TEST_OUTPUT=$(npm test -- --passWithNoTests --coverage=false 2>&1)
if [ $? -ne 0 ]; then
  FAILED=1
  ERRORS="$ERRORS\n[TESTS FAILED]\n$TEST_OUTPUT\n"
  echo "  FAILED - see errors below"
else
  echo "  OK"
fi
echo ""

# Step 3: Security
echo "[SECURITY] Checking npm audit..."
AUDIT_OUTPUT=$(npm audit --audit-level=high 2>&1)
if [ $? -ne 0 ]; then
  FAILED=1
  ERRORS="$ERRORS\n[SECURITY VULNERABILITIES]\n$AUDIT_OUTPUT\nRun 'npm audit fix' to fix.\n"
  echo "  FAILED - vulnerabilities found"
else
  echo "  OK - no high severity issues"
fi
echo ""

# Result
if [ $FAILED -ne 0 ]; then
  echo ""
  echo "========================================"
  echo "PRE-PUSH FAILED - ERRORS:"
  echo "========================================"
  echo -e "$ERRORS"
  echo "========================================"
  echo "Fix the above errors and try again."
  exit 1
fi

echo "All checks passed - pushing..."
