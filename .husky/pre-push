#!/bin/sh
# ===========================================
# Pre-Push Hook - Runs before each push
# ===========================================
# This hook runs comprehensive checks before pushing to remote.
# If any check fails, the push will be aborted.

echo "ğŸš€ Running pre-push checks..."
echo ""

# Track if any check fails
FAILED=0

# Navigate to api-service directory
cd api-service

# 1. Run full linting
echo "ğŸ“ Step 1/3: Running full lint check..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed!"
  FAILED=1
else
  echo "âœ… Linting passed!"
fi
echo ""

# 2. Run unit tests
echo "ğŸ§ª Step 2/3: Running unit tests..."
npm test -- --passWithNoTests --coverage=false 2>/dev/null
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed!"
  FAILED=1
else
  echo "âœ… Unit tests passed!"
fi
echo ""

# 3. Check for security vulnerabilities
echo "ğŸ”’ Step 3/3: Checking for security vulnerabilities..."
npm audit --audit-level=high 2>/dev/null
if [ $? -ne 0 ]; then
  echo "âš ï¸  Security vulnerabilities found (high severity)!"
  echo "ğŸ’¡ Tip: Run 'npm audit fix' to fix them."
  FAILED=1
else
  echo "âœ… No high severity vulnerabilities!"
fi
echo ""

cd ..

# Final result
if [ $FAILED -ne 0 ]; then
  echo "============================================"
  echo "âŒ Pre-push checks FAILED!"
  echo "Please fix the issues above before pushing."
  echo "============================================"
  exit 1
fi

echo "============================================"
echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Pushing to remote..."
echo "============================================"
