#!/bin/sh
# ===========================================
# Pre-Push Hook - Runs before each push
# ===========================================
# This hook runs comprehensive checks before pushing to remote.
# If any check fails, the push will be aborted.

echo "üöÄ Running pre-push checks..."
echo ""

# Track if any check fails
FAILED=0

# ===========================================
# Step 0: Validate Branch Naming Convention
# ===========================================
# Allowed patterns:
#   - feature/<number>-description (e.g., feature/123-add-login)
#   - feat/<number>-description
#   - fix/<number>-description
#   - bugfix/<number>-description
#   - hotfix/<number>-description
#   - chore/<number>-description
#   - docs/<number>-description
#   - refactor/<number>-description
#   - test/<number>-description
#   - style/<number>-description
#   - perf/<number>-description
#   - ci/<number>-description
#   - main, master, develop (protected branches - allowed)
# ===========================================

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

echo "üåø Step 0/4: Validating branch name: '$BRANCH_NAME'"

# Allow main branches without restrictions
if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "master" ] || [ "$BRANCH_NAME" = "develop" ]; then
  echo "‚úÖ Protected branch '$BRANCH_NAME' - naming check skipped"
else
  # Pattern: type/number-description
  # - type: feature|feat|fix|bugfix|hotfix|chore|docs|refactor|test|style|perf|ci
  # - number: one or more digits (task/issue number)
  # - description: lowercase letters, numbers, and hyphens
  VALID_PATTERN="^(feature|feat|fix|bugfix|hotfix|chore|docs|refactor|test|style|perf|ci)/[0-9]+-[a-z0-9-]+$"
  
  if echo "$BRANCH_NAME" | grep -Eq "$VALID_PATTERN"; then
    echo "‚úÖ Branch name follows convention!"
  else
    echo ""
    echo "‚ùå Invalid branch name: '$BRANCH_NAME'"
    echo ""
    echo "Branch names must follow this pattern:"
    echo "  <type>/<task-number>-<description>"
    echo ""
    echo "Allowed types:"
    echo "  feature, feat, fix, bugfix, hotfix, chore,"
    echo "  docs, refactor, test, style, perf, ci"
    echo ""
    echo "Examples:"
    echo "  feature/123-add-user-login"
    echo "  fix/456-resolve-memory-leak"
    echo "  chore/789-update-dependencies"
    echo "  docs/101-update-readme"
    echo ""
    echo "The number should reference your task/issue number."
    echo ""
    exit 1
  fi
fi
echo ""

# Navigate to api-service directory
cd api-service

# 1. Run full linting
echo "üìù Step 1/4: Running full lint check..."
npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå Linting failed!"
  FAILED=1
else
  echo "‚úÖ Linting passed!"
fi
echo ""

# 2. Run unit tests
echo "üß™ Step 2/4: Running unit tests..."
npm test -- --passWithNoTests --coverage=false 2>/dev/null
if [ $? -ne 0 ]; then
  echo "‚ùå Unit tests failed!"
  FAILED=1
else
  echo "‚úÖ Unit tests passed!"
fi
echo ""

# 3. Check for security vulnerabilities
echo "üîí Step 3/4: Checking for security vulnerabilities..."
npm audit --audit-level=high 2>/dev/null
if [ $? -ne 0 ]; then
  echo "‚ö†Ô∏è  Security vulnerabilities found (high severity)!"
  echo "üí° Tip: Run 'npm audit fix' to fix them."
  FAILED=1
else
  echo "‚úÖ No high severity vulnerabilities!"
fi
echo ""

cd ..

# Final result
if [ $FAILED -ne 0 ]; then
  echo "============================================"
  echo "‚ùå Pre-push checks FAILED!"
  echo "Please fix the issues above before pushing."
  echo "============================================"
  exit 1
fi

echo "============================================"
echo "‚úÖ All pre-push checks passed!"
echo "üöÄ Pushing to remote..."
echo "============================================"
